# ============================================================================
# DOCKER COMPOSE CONFIGURATION - SOURCE OF TRUTH
# ============================================================================
# This file defines ALL runtime configuration (ports, volumes, env vars).
# Used by both:
#   - VS Code dev containers (.devcontainer/devcontainer.json)
#   - Smoke test script (idea-app smoke-test)
#
# For VS Code-specific settings (extensions, editor config),
# edit .devcontainer/devcontainer.json instead.
# ============================================================================

services:
  app:
    build:
      context: ..
      dockerfile: app_src/Dockerfile
      target: ${DOCKER_TARGET:-development} # Use development by default, override with DOCKER_TARGET env var

    volumes:
      # Mount app source for live editing and auto-reload
      - ../app_src:/app

      # Mount dev mock files directory (can be empty)
      - ../dev_mocks:/app/dev_mocks

      # Mount AWS credentials for container (generated by provide_role)
      - ../.aws-dev:/home/appuser/.aws:ro

      # Persist UV cache across container rebuilds (vscode user, not root)
      - uv-cache:/home/appuser/.cache/uv

    environment:
      # Dev mode authentication (ADD YOUR ENV VARS HERE)
      - COGNITO_AUTH_DEV_MODE=true
      - COGNITO_AUTH_CONFIG_PATH=/app/dev_mocks/dev_mock_authoriser.json
      - COGNITO_AUTH_DEV_CONFIG=/app/dev_mocks/dev_mock_user.json

    ports:
      - "8080:8080" # Map host port 8080 to container port 8080

volumes:
  uv-cache:
